name: Generate Release Notes

on:
  workflow_dispatch:
    inputs:
      time_period:
        description: 'Time period for release notes'
        required: true
        default: 'last-month'
        type: choice
        options:
          - last-week
          - last-month
          - last-quarter
      slack_notify:
        description: 'Send to Slack'
        required: false
        default: true
        type: boolean
      single_repo:
        description: 'Generate for a single repository (leave empty for all configured repos)'
        required: false
        type: string
#  schedule:
#    # Run on the 1st of every month at 8:00 AM UTC
#    - cron: '0 8 1 * *'

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # This is needed for pushing to the repo
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create config file
        run: |
          cat > config.yml << EOF
          # GitHub API Token
          # github_token automatically provided by GitHub Actions
          
          # GitHub organization
          organization: "keboola"
          
          # Time period for release notes
          time_period: "${{ github.event.inputs.time_period || 'last-month' }}"
          
          # Repository search patterns
          repo_patterns:
            - "component"
          
          # Template directory
          template_dir: "templates"
          
          # Output file
          output_file: "release-notes.md"
          
          # AI-powered description generation
          use_ai: ${{ secrets.AI_API_KEY != '' }}
          ai_provider: "openai"
          
          # Slack integration
          slack_enabled: ${{ (github.event.inputs.slack_notify == true || github.event_name == 'schedule') && secrets.SLACK_WEBHOOK_URL != '' }}
          EOF
      
      - name: Generate release notes
        run: python main.py ${{ github.event.inputs.single_repo != '' && format('-r {0}', github.event.inputs.single_repo) || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Commit release notes to repository
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions@github.com'
          git add release-notes.md
          git commit -m "Update release notes for ${{ github.event.inputs.time_period }}${{ github.event.inputs.single_repo != '' && format(' [repo: {0}]', github.event.inputs.single_repo) || '' }}"
          git push 